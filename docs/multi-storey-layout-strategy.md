# Multi-storey Layout Strategy (Phase 6-1)

このドキュメントは、既存の単層レイアウト品質を維持しつつ複層建物へ拡張するための
**2段階ソルブ戦略**を定義する。

## 目的

- 単層（single-storey）入力で既存挙動を変えない。
- 複層（multi-storey）入力で、階ごとの平面最適化と縦動線コア整合を分離して解く。
- 将来の `VerticalCoreSpec` / `CirculationSpec` 導入に接続しやすい責務分離を行う。

## Stage 1: Per-floor 2D solve（階別平面解）

各階を独立問題として既存ソルバAPIに投入する。

1. `storey_id`（なければ `storey_elevation`）で空間を階に分割する。
2. 各階で `TopologyGraph` のサブグラフを作る。
3. 既存の単層ソルバ（`heuristic` / `ortools`）をそのまま適用する。
4. 出力は階ローカル座標で保持し、まだ垂直コア位置は固定しない。

### Stage 1 制約

- 既存単層の目的関数・制約は変更しない。
- 階内でのみ非重複・隣接・接続制約を満たす。
- 階間の拘束（シャフト整列等）は Stage 2 でのみ扱う。

## Stage 2: Vertical core alignment solve（垂直コア整合解）

Stage 1 出力を入力に、階間で共有される垂直要素（階段・エレベータ）の XY を整列させる。

1. 各階の候補コア領域（core candidate）を列挙する。
2. 共有コアごとに「全階共通XY」または「許容移動半径内」の整列制約を課す。
3. 必要なら階全体の剛体平行移動（translation）で衝突を再解消する。
4. 整列後に階間整合チェックを実施し、失敗時はペナルティ付き再最適化またはフォールバックを実行する。

### Stage 2 目的

- 階段: 廊下近接・デッドエンド回避を満たす配置を優先。
- エレベータ: 各階の主要空間への加重移動距離が最小になる配置を優先。
- 複数コア: 需要分担が偏らないようサービス半径のばらつきを抑制。

## 後方互換性ポリシー

- `storey_count == 1` では Stage 2 をスキップし、既存挙動と同一にする。
- `multi_storey_mode=false`（導入予定）でも Stage 2 を無効化し、現行品質を維持する。
- 既存テストの単層ゴールデン比較を回帰基準として扱う。

## 受け入れ条件（6-1時点）

- 戦略を文書で定義し、Stage 1/2 の責務境界が明確である。
- 単層入力の挙動不変ポリシーが明記されている。
- 6-2/6-3 で実装するコア事前配置・OR-Tools拡張へ接続可能な仕様になっている。
